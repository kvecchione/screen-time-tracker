<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Time Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .child-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .child-btn {
            padding: 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .child-btn.active {
            background: #667eea;
            color: white;
        }

        .child-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .daily-summary {
            text-align: center;
            margin-bottom: 20px;
            padding: 25px;
            background: white;
            color: #333;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(37, 99, 235, 0.3);
            border: 2px solid #667eea;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
        }

        .daily-summary h2 {
            grid-column: 1 / -1;
            margin: 0 0 10px 0;
        }

        .summary-stat {
            margin: 0;
            font-size: 1rem;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .summary-stat strong {
            font-size: 1.4rem;
            display: block;
            margin-top: 8px;
        }

        .goals-list {
            display: grid;
            gap: 15px;
        }

        .goal-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-title {
            font-weight: bold;
            font-size: 1.1rem;
            flex: 1;
        }

        .reorder-controls {
            display: flex;
            gap: 5px;
        }

        .reorder-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.2s ease;
        }

        .reorder-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .reorder-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .goal-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
        }

        .goal-btn {
            flex: 1;
            min-width: 0;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .earned-btn {
            background: #28a745;
            color: white;
        }

        .earned-btn:hover {
            background: #218838;
        }

        .not-earned-btn {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .not-earned-btn:hover {
            background: #f0f0f0;
        }

        .pending-btn {
            background: #ffc107;
            color: #333;
        }

        .pending-btn:hover {
            background: #e0a800;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-badge.earned {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.not-earned {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .weekly-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .add-form {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .form-group label {
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 15px;
            }
        }
    </style>
        <!-- Favicon / App icons -->
        <link rel="icon" href="/static/img/favicon.svg" sizes="any" type="image/svg+xml">
        <!-- PNG fallback and legacy ICO for browsers that don't use SVG favicons -->
        <link rel="icon" href="/static/img/icon-192.png" sizes="192x192" type="image/png">
        <link rel="shortcut icon" href="/static/img/favicon.ico">
        <link rel="apple-touch-icon" href="/static/img/apple-touch-icon.png">
        <link rel="manifest" href="/static/manifest.json">
        <meta name="theme-color" content="#667eea">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Screen Time Tracker</h1>
        </div>

        <div class="card" id="childSelectorCard">
            <h2 style="margin-bottom: 15px; text-align: center;">Child</h2>
            <div class="child-selector" id="childSelector"></div>
        </div>

        <div id="mainContent"></div>

        <div style="text-align: center; margin-top: 30px;">
                <a href="/admin/" target="_blank" style="display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; transition: all 0.3s ease;" onmouseover="this.style.background='#764ba2'" onmouseout="this.style.background='#667eea'">
                ‚öôÔ∏è Admin
            </a>
        </div>
    </div>

    <script>
        // Resolve API URL relative to the current host so app works on any domain
        const API_URL = new URL('/api', window.location.origin).href;
        
        // Helper function to get CSRF token
        function getCsrfToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === ('csrftoken' + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        let selectedChild = null;
        let children = [];
        let goals = [];

        // Initialize
        async function init() {
            await loadChildren();
        }

        async function loadChildren() {
            try {
                const response = await fetch(`${API_URL}/children/`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    children = data.results || data;
                    renderChildren();
                    if (children.length > 0) {
                        // Restore previously selected child from localStorage, or use first child
                        const savedChildId = localStorage.getItem('selectedChildId');
                        const childId = savedChildId && children.find(c => c.id === parseInt(savedChildId)) 
                            ? parseInt(savedChildId) 
                            : children[0].id;
                        
                        selectChild(childId);
                    }
                }
            } catch (error) {
                console.error('Error loading children:', error);
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="color: #dc3545;">
                        <p>‚ö†Ô∏è Unable to connect to server.</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Run: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">python manage.py runserver</code></p>
                    </div>
                `;
            }
        }

        function renderChildren() {
            const selector = document.getElementById('childSelector');
            selector.innerHTML = children.map(child => `
                <button class="child-btn ${selectedChild?.id === child.id ? 'active' : ''}" 
                        onclick="selectChild(${child.id})">
                    ${child.name}
                </button>
            `).join('');
            document.getElementById('childSelectorCard').style.display = 'block';
        }
        
        function hideChildSelector() {
            document.getElementById('childSelectorCard').style.display = 'none';
        }
        
        function showChildSelector() {
            document.getElementById('childSelectorCard').style.display = 'block';
        }

        async function selectChild(childId) {
            const child = children.find(c => c.id === childId);
            selectedChild = child;
            localStorage.setItem('selectedChildId', childId);
            renderChildren();
            await loadGoals();
            renderDashboard();
        }

        async function loadGoals() {
            try {
                const response = await fetch(`${API_URL}/goals/?child_id=${selectedChild.id}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    goals = data.results || data;
                }
            } catch (error) {
                console.error('Error loading goals:', error);
            }
        }

        // Day navigation
        let currentDate = new Date();

        function formatMinutesHuman(minutes) {
            if (minutes === null || minutes === undefined || isNaN(minutes)) return '0m';
            const sign = minutes < 0 ? '-' : '';
            const abs = Math.abs(Math.round(minutes));
            const hours = Math.floor(abs / 60);
            const mins = abs % 60;
            if (hours > 0) return `${sign}${hours}h ${mins}m`;
            return `${sign}${mins}m`;
        }

        function getWeekStart(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            // Format using local time (avoids UTC shifting the date)
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDayCode(date) {
            const day_map = {0: 'sun', 1: 'mon', 2: 'tue', 3: 'wed', 4: 'thu', 5: 'fri', 6: 'sat'};
            return day_map[new Date(date).getDay()];
        }

        function parseLocalDate(dateStr) {
            // Parse "YYYY-MM-DD" as local date instead of UTC
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }


        async function getDailyTrackingsForDate(date) {
            const dateStr = formatDate(new Date(date));
                // Use batch endpoint to fetch all trackings for the given goals and date
                try {
                    const payload = {
                        goal_ids: goals.map(g => g.id),
                        dates: [dateStr]
                    };
                    const res = await fetch(`${API_URL}/daily-tracking/batch/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        const data = await res.json();
                        return data || [];
                    }
                } catch (err) {
                    console.error('Batch tracking fetch error', err);
                }
                return [];
        }

        async function getWeeklyTrackings(weekStart) {
                    // Use batch endpoint to fetch all trackings for the week in one request
                    const dates = [];
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    for (let d = new Date(weekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
                        dates.push(formatDate(new Date(d)));
                    }

                    try {
                        const payload = { goal_ids: goals.map(g => g.id), dates };
                        const res = await fetch(`${API_URL}/daily-tracking/batch/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (res.ok) {
                            const data = await res.json();
                            return data || [];
                        }
                    } catch (err) {
                        console.error('Batch weekly fetch error', err);
                    }

                    return [];
        }

        async function getAdhocRewards(dateStr) {
            try {
                const response = await fetch(`${API_URL}/adhoc-rewards/?child_id=${selectedChild.id}&date=${dateStr}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.results || data || [];
                }
            } catch (error) {
                console.error('Error loading adhoc rewards:', error);
            }
            return [];
        }

        async function getAdhocPenalties(dateStr) {
            try {
                const response = await fetch(`${API_URL}/adhoc-penalties/?child_id=${selectedChild.id}&date=${dateStr}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.results || data || [];
                }
            } catch (error) {
                console.error('Error loading adhoc penalties:', error);
            }
            return [];
        }

        async function getScreenTimeUsage(dateStr) {
            try {
                const response = await fetch(`${API_URL}/screen-time-usage/?child_id=${selectedChild.id}&date=${dateStr}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.results?.[0] || null;
                }
            } catch (error) {
                console.error('Error loading screen time usage:', error);
            }
            return null;
        }

        async function getWeeklyScreenTimeUsage(weekStart, weekEnd) {
            // Fetch all usage records for the week
            const dates = [];
            for (let d = new Date(weekStart); d < weekEnd; d.setDate(d.getDate() + 1)) {
                dates.push(formatDate(new Date(d)));
            }
            
            try {
                const payload = { dates };
                const response = await fetch(`${API_URL}/screen-time-usage/?child_id=${selectedChild.id}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const usageList = data.results || data || [];
                    // Filter to only this week's dates
                    return usageList.filter(usage => {
                        const usageDate = parseLocalDate(usage.date);
                        return usageDate >= weekStart && usageDate < weekEnd;
                    });
                }
            } catch (error) {
                console.error('Error loading weekly usage:', error);
            }
            return [];
        }

        async function renderDashboard() {
            showChildSelector();
            if (!selectedChild) {
                return;
            }

            // Fetch day and week summaries from backend to centralize calculations
            const dateStr = formatDate(currentDate);
            const [dailyResp, weeklyResp, adhocRewards, adhocPenalties, usageData] = await Promise.all([
                fetch(`${API_URL}/children/${selectedChild.id}/daily_summary/?date=${dateStr}`),
                fetch(`${API_URL}/children/${selectedChild.id}/weekly_summary/?date=${dateStr}`),
                getAdhocRewards(dateStr),
                getAdhocPenalties(dateStr),
                getScreenTimeUsage(dateStr)
            ]);

            const dailySummary = dailyResp.ok ? await dailyResp.json() : null;
            const weeklySummary = weeklyResp.ok ? await weeklyResp.json() : null;

            const trackings = dailySummary?.goals || [];
            let weekStart = weeklySummary?.week_start ? parseLocalDate(weeklySummary.week_start) : getWeekStart(currentDate);
            let weekEnd = weeklySummary?.week_end ? parseLocalDate(weeklySummary.week_end) : new Date(new Date(weekStart).setDate(new Date(weekStart).getDate() + 6));
            
            // Reset time components to midnight for proper date comparison
            weekStart = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
            weekEnd = new Date(weekEnd.getFullYear(), weekEnd.getMonth(), weekEnd.getDate());
            // Set weekEnd to the start of the next day (exclusive) so Sunday is fully included
            weekEnd.setDate(weekEnd.getDate() + 1);

            // Fetch weekly usage after we know the week boundaries
            const weeklyUsageList = await getWeeklyScreenTimeUsage(weekStart, weekEnd);
            const totalWeeklyUsed = weeklyUsageList.reduce((sum, usage) => sum + (usage.minutes_used || 0), 0);

            const weeklyAdhocRewards = adhocRewards
                .filter(reward => {
                    const rewardDate = parseLocalDate(reward.awarded_date);
                    return rewardDate >= weekStart && rewardDate < weekEnd;
                });
            const totalAdhocRewards = weeklyAdhocRewards.reduce((sum, r) => sum + r.minutes, 0);

            const weeklyAdhocPenalties = adhocPenalties
                .filter(penalty => {
                    const penaltyDate = parseLocalDate(penalty.applied_date);
                    return penaltyDate >= weekStart && penaltyDate < weekEnd;
                });
            const totalAdhocPenalties = weeklyAdhocPenalties.reduce((sum, p) => sum + p.minutes, 0);

            // Only show the ad-hoc bonus entries for the currently selected day
            const dailyAdhocRewards = adhocRewards
                .filter(reward => {
                    const rewardDate = parseLocalDate(reward.awarded_date);
                    const currentDateOnly = new Date(currentDate);
                    return rewardDate.toDateString() === currentDateOnly.toDateString();
                });

            // Only show the ad-hoc penalty entries for the currently selected day
            const dailyAdhocPenalties = adhocPenalties
                .filter(penalty => {
                    const penaltyDate = parseLocalDate(penalty.applied_date);
                    const currentDateOnly = new Date(currentDate);
                    return penaltyDate.toDateString() === currentDateOnly.toDateString();
                });

            // Calculate today's potential reward (still client-side since it's goal metadata)
            const dayCode = getDayCode(currentDate);
            const dayReward = goals
                .filter(g => g.applies_to_days && g.applies_to_days.includes(dayCode))
                .reduce((sum, g) => sum + g.reward_minutes, 0);

            // Only count earned minutes from goals that still apply to this child
            const totalEarned = dailySummary?.total_earned_minutes ?? trackings
                .filter(t => {
                    if (t.status !== 'earned') return false;
                    // Find the goal for this tracking
                    const goal = goals.find(g => g.id === t.goal);
                    // Only count if goal exists and child is in the goal's children list
                    return goal && goal.children && goal.children.some(c => c.id === selectedChild.id);
                })
                .reduce((sum, t) => sum + (t.minutes_earned || 0), 0);

            // Add rewards awarded today to the daily total
            const todayRewards = adhocRewards
                .filter(reward => {
                    const rewardDate = parseLocalDate(reward.awarded_date);
                    const currentDateOnly = new Date(currentDate);
                    return rewardDate.toDateString() === currentDateOnly.toDateString();
                })
                .reduce((sum, r) => sum + r.minutes, 0);

            // Subtract penalties applied today from the daily total
            const todayPenalties = adhocPenalties
                .filter(penalty => {
                    const penaltyDate = parseLocalDate(penalty.applied_date);
                    const currentDateOnly = new Date(currentDate);
                    return penaltyDate.toDateString() === currentDateOnly.toDateString();
                })
                .reduce((sum, p) => sum + p.minutes, 0);

            const totalDailyEarned = totalEarned + todayRewards - todayPenalties;

            // Use backend weekly totals when available
            const weeklyCumulativeEarned = weeklySummary?.total_earned_minutes || 0;
            const weeklyTotal = (weeklySummary?.total_baseline_minutes || selectedChild.baseline_weekly_minutes || 0) + weeklyCumulativeEarned + totalAdhocRewards - totalAdhocPenalties;
            
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[currentDate.getDay()];
            const dateDisplay = currentDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
            const weekDisplay = `${weekStart.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${weekEnd.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}`;
            
            // determine which goals apply to the current day (reuse `dayCode` declared above)
            const visibleGoals = goals.filter(g => {
                const daysArray = g.applies_to_days ? g.applies_to_days.split(',').map(d => d.trim()) : [];
                return daysArray.length === 0 || daysArray.includes(dayCode);
            });

            let html = `
                <div class="daily-summary">
                    <h2>${selectedChild.name}'s Screen Time</h2>
                    <div class="summary-stat">
                        Earned 
                        <strong>${formatMinutesHuman(weeklyTotal)}</strong>
                    </div>
                    <div class="summary-stat">
                        Used
                        <strong>${formatMinutesHuman(totalWeeklyUsed)}</strong>
                    </div>
                    <div class="summary-stat">
                        Remaining
                        <strong>${formatMinutesHuman(Math.max(0, weeklyTotal - totalWeeklyUsed))}</strong>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <button class="btn-primary" style="flex: 0 1 auto; padding: 8px 12px; font-size: 0.9rem;" onclick="previousDay()">‚Üê Previous</button>
                        <h2 style="margin: 0; flex: 1; text-align: center; font-size: 1.1rem;">${dayName} (${dateDisplay})</h2>
                        <button class="btn-primary" style="flex: 0 1 auto; padding: 8px 12px; font-size: 0.9rem;" onclick="nextDay()">Next ‚Üí</button>
                    </div>
                    <h2 style="margin-bottom: 15px;">Goals</h2>
                    <div class="goals-list">
            `;

            if (visibleGoals.length === 0) {
                html += `
                    <div class="empty-state">
                        <p>No goals set yet. Add one to get started!</p>
                    </div>
                `;
            } else {
                visibleGoals.forEach((goal, index) => {
                    const tracking = trackings.find(t => t.goal === goal.id);
                    const status = tracking?.status || 'not_earned';
                    const earned = tracking?.minutes_earned || 0;
                    const bonusEarned = tracking?.bonus_earned || false;
                    const actualMinutes = tracking?.actual_minutes || 0;
                    
                    // Parse days
                    const daysArray = goal.applies_to_days ? goal.applies_to_days.split(',').map(d => d.trim()) : [];
                    const dayNames = {mon: 'Mon', tue: 'Tue', wed: 'Wed', thu: 'Thu', fri: 'Fri', sat: 'Sat', sun: 'Sun'};
                    
                    // Format days display
                    let daysDisplay;
                    if (daysArray.length === 7) {
                        daysDisplay = 'All';
                    } else if (daysArray.length === 5 && ['mon', 'tue', 'wed', 'thu', 'fri'].every(d => daysArray.includes(d))) {
                        daysDisplay = 'Weekdays';
                    } else {
                        daysDisplay = daysArray.map(d => dayNames[d]).join(', ');
                    }

                    html += `
                        <div class="goal-card">
                            <div class="goal-header">
                                <div class="goal-title">${goal.name}</div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="reorder-btn" style="background: #0066cc; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="showEditGoalForm(${goal.id})" title="Edit goal">‚úé</button>
                                    <button class="reorder-btn" style="background: #666; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="moveGoal(${goal.id}, 'up')" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                                    <button class="reorder-btn" style="background: #666; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="moveGoal(${goal.id}, 'down')" ${index === visibleGoals.length - 1 ? 'disabled' : ''}>‚ñº</button>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin: 8px 0;">
                                ${goal.goal_type === 'tracked' ? `Earns: ${goal.reward_per_hour} mins/hr` : `Earns: ${formatMinutesHuman(goal.reward_minutes)}${goal.bonus_minutes > 0 ? ` (+${formatMinutesHuman(goal.bonus_minutes)})` : ''}`} | Days: ${daysDisplay}
                            </div>
                            ${goal.goal_type === 'tracked' ? `
                                <div style="margin: 12px 0;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">Time Spent (hours):</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <button class="btn-primary" style="padding: 8px 12px; font-size: 1rem;" onclick="changeTrackedHours(${goal.id}, -1)">‚àí</button>
                                        <input type="number" id="actualMinutes_${goal.id}" value="${Math.floor(actualMinutes / 60)}" min="0" placeholder="0" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" readonly>
                                        <button class="btn-primary" style="padding: 8px 12px; font-size: 1rem;" onclick="changeTrackedHours(${goal.id}, 1)">+</button>
                                    </div>
                                    ${actualMinutes > 0 ? `<div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Time Spent: ${Math.floor(actualMinutes / 60)} hrs | Earned: ${Math.floor(actualMinutes / 60) * goal.reward_per_hour} mins</div>` : ''}
                                </div>
                            ` : `
                                <div class="goal-controls">
                                    <button class="goal-btn ${status === 'earned' ? 'earned-btn' : 'not-earned-btn'}" onclick="updateTracking(${goal.id}, '${status === 'earned' ? 'not_earned' : 'earned'}', ${status === 'earned' ? 0 : goal.reward_minutes}, false)">
                                        ${status === 'earned' ? '‚úì Earned' : '‚≠ï Mark Earned'}
                                    </button>
                                    ${goal.bonus_minutes > 0 && status === 'earned' ? `
                                        <button class="goal-btn ${bonusEarned ? 'earned-btn' : 'not-earned-btn'}" style="font-size: 0.9rem;" onclick="updateTracking(${goal.id}, 'earned', ${goal.reward_minutes + (bonusEarned ? 0 : goal.bonus_minutes)}, ${!bonusEarned})">
                                            ${bonusEarned ? '‚≠ê Without Being Asked!' : '‚≠ê Without Being Asked'}
                                        </button>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    `;
                });
            }

            html += `
                    </div>
            `;

            // Display ad-hoc rewards if any exist
            if (dailyAdhocRewards.length > 0) {
                html += `
                    <h2 style="margin-bottom: 15px; margin-top: 20px;">Rewards</h2>
                    <div class="goals-list">
                `;
                dailyAdhocRewards.forEach(reward => {
                    html += `
                        <div class="goal-card">
                            <div class="goal-header">
                                <div class="goal-title">${reward.reason}</div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="reorder-btn" style="background: #0066cc; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="showEditRewardForm(${reward.id}, ${reward.minutes}, '${reward.reason.replace(/'/g, "\\'")}')">‚úé</button>
                                    <button class="reorder-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="deleteAdhocReward(${reward.id})">‚úï</button>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin: 8px 0;">
                                <strong>${formatMinutesHuman(reward.minutes)}</strong>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                `;
            }

            // Display ad-hoc penalties if any exist
            if (dailyAdhocPenalties.length > 0) {
                html += `
                    <h2 style="margin-bottom: 15px; margin-top: 20px;">Penalties</h2>
                    <div class="goals-list">
                `;
                dailyAdhocPenalties.forEach(penalty => {
                    html += `
                        <div class="goal-card">
                            <div class="goal-header">
                                <div class="goal-title">${penalty.reason}</div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="reorder-btn" style="background: #0066cc; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="showEditPenaltyForm(${penalty.id}, ${penalty.minutes}, '${penalty.reason.replace(/'/g, "\\'")}')">‚úé</button>
                                    <button class="reorder-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="deleteAdhocPenalty(${penalty.id})">‚úï</button>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin: 8px 0;">
                                <strong>-${formatMinutesHuman(penalty.minutes)}</strong>
                            </div>
                        </div>
                    `;
                });
                html += `
                    </div>
                `;
            }

            // Display screen time usage for this day
            if (usageData && usageData.minutes_used > 0) {
                html += `
                    <h2 style="margin-bottom: 15px; margin-top: 20px;">Usage</h2>
                    <div class="goals-list">
                        <div class="goal-card">
                            <div class="goal-header">
                                <div class="goal-title">${usageData.notes || "Screen Time Usage"}</div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="reorder-btn" style="background: #0066cc; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="showEditUsageForm(${usageData.id}, ${usageData.minutes_used}, '${usageData.notes.replace(/'/g, "\\'")}')">‚úé</button>
                                    <button class="reorder-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" onclick="deleteScreenTimeUsage(${usageData.id})">‚úï</button>
                                </div>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin: 8px 0;">
                                <strong>${formatMinutesHuman(usageData.minutes_used)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <button class="btn-primary" style="margin-top: 15px;" onclick="showAddGoalForm()">üéØ Add Goal</button>
                        <button class="btn-primary" style="margin-top: 15px;" onclick="showAdhocRewardForm()">‚≠ê Reward</button>
                        <button class="btn-primary" style="margin-top: 15px;" onclick="showAdhocPenaltyForm()">‚ö†Ô∏è Penalty</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;">
                        <button class="btn-primary" style="margin-top: 5px;" onclick="showScreenTimeUsageForm()">üì± Log Usage</button>
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
        }

        function previousDay() {
            currentDate = new Date(currentDate);
            currentDate.setDate(currentDate.getDate() - 1);
            renderDashboard();
        }

        function nextDay() {
            const today = new Date();
            currentDate = new Date(currentDate);
            currentDate.setDate(currentDate.getDate() + 1);
            // Don't go beyond today
            if (currentDate > today) {
                currentDate = new Date(today);
            }
            renderDashboard();
        }

        async function getDailyTrackings() {
            return getDailyTrackingsForDate(new Date());
        }

        function changeTrackedHours(goalId, delta) {
            const input = document.getElementById(`actualMinutes_${goalId}`);
            let currentValue = parseInt(input.value) || 0;
            currentValue = Math.max(0, currentValue + delta);
            input.value = currentValue;
            // Autosave when hours change
            updateTrackedGoal(goalId);
        }

        async function updateTrackedGoal(goalId) {
            const inputHours = parseFloat(document.getElementById(`actualMinutes_${goalId}`).value) || 0;
            const actualMinutes = inputHours * 60; // Convert hours to minutes
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            // Calculate minutes earned: reward_per_hour * completed hours
            const completedHours = Math.floor(actualMinutes / 60);
            const minutesEarned = completedHours * goal.reward_per_hour;
            
            // Track status as earned if any time was spent
            const status = actualMinutes > 0 ? 'earned' : 'not_earned';

            const dateStr = formatDate(currentDate);
            
            try {
                // First, try to find existing tracking for this child
                let trackingId = null;
                const trackingsResponse = await fetch(
                    `${API_URL}/daily-tracking/?child_id=${selectedChild.id}&goal_id=${goalId}&date=${dateStr}`,
                    { headers: { 'Content-Type': 'application/json' } }
                );
                
                if (trackingsResponse.ok) {
                    const data = await trackingsResponse.json();
                    const existing = (data.results || data || [])[0];
                    trackingId = existing?.id;
                }

                const method = trackingId ? 'PATCH' : 'POST';
                const url = trackingId 
                    ? `${API_URL}/daily-tracking/${trackingId}/`
                    : `${API_URL}/daily-tracking/`;

                const payload = {
                    child: selectedChild.id,
                    goal: goalId,
                    date: dateStr,
                    status: status,
                    minutes_earned: minutesEarned,
                    actual_minutes: actualMinutes,
                    bonus_earned: false
                };

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    await renderDashboard();
                } else {
                    alert('Error updating tracked goal');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating tracked goal');
            }
        }

        async function updateTracking(goalId, status, minutes, bonusEarned = false) {
            const dateStr = formatDate(currentDate);
            
            try {
                // First, try to find existing tracking for this child
                let trackingId = null;
                const trackingsResponse = await fetch(
                    `${API_URL}/daily-tracking/?child_id=${selectedChild.id}&goal_id=${goalId}&date=${dateStr}`,
                    { headers: { 'Content-Type': 'application/json' } }
                );
                
                if (trackingsResponse.ok) {
                    const data = await trackingsResponse.json();
                    const existing = (data.results || data || [])[0];
                    trackingId = existing?.id;
                }

                const method = trackingId ? 'PATCH' : 'POST';
                const url = trackingId 
                    ? `${API_URL}/daily-tracking/${trackingId}/`
                    : `${API_URL}/daily-tracking/`;

                const payload = {
                    child: selectedChild.id,
                    goal: goalId,
                    date: dateStr,
                    status: status,
                    minutes_earned: minutes,
                    bonus_earned: bonusEarned
                };

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    await renderDashboard();
                } else {
                    alert('Error updating tracking');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating tracking');
            }
        }

        async function moveGoal(goalId, direction) {
            try {
                // Find the goal's current position
                const currentIndex = goals.findIndex(g => g.id === goalId);
                if (currentIndex === -1) return;

                // Calculate new index
                let newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                if (newIndex < 0 || newIndex >= goals.length) return;

                // Create new order array
                const newOrder = goals.map(g => g.id);
                [newOrder[currentIndex], newOrder[newIndex]] = [newOrder[newIndex], newOrder[currentIndex]];

                // Send reorder request
                const response = await fetch(`${API_URL}/goals/reorder/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ goals: newOrder })
                });

                if (response.ok) {
                    // Update local goals array with new order
                    await loadGoals();
                    await renderDashboard();
                } else {
                    alert('Error reordering goals');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error reordering goals');
            }
        }

        function showAddGoalForm() {
            hideChildSelector();
            
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Add New Goal</h2>
                    <form onsubmit="createGoal(event)" novalidate>
                        <div class="form-group">
                            <label>Goal Name</label>
                            <input type="text" id="goalName" placeholder="e.g., Math Practice, Read a book">
                        </div>
                        <div class="form-group">
                            <label>Applies to Children</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                                ${children.map(child => `
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" value="${child.id}" class="child-checkbox" checked style="margin-right: 6px;">
                                        ${child.name}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Goal Type</label>
                            <select id="goalType" onchange="toggleTargetMinutes()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="binary">Binary (Earned/Not Earned)</option>
                                <option value="tracked">Tracked (Hours)</option>
                            </select>
                        </div>
                        <div class="form-group" id="rewardMinutesGroup">
                            <label>Reward Minutes</label>
                            <input type="number" id="rewardMinutes" placeholder="30" min="1">
                        </div>
                        <div class="form-group" id="rewardPerHourGroup" style="display: none;">
                            <label>Reward Minutes per Hour</label>
                            <input type="number" id="rewardPerHour" placeholder="30" min="1">
                        </div>
                        <div class="form-group" id="bonusMinutesGroup">
                            <label>Bonus Minutes (without being asked) - Optional</label>
                            <input type="number" id="bonusMinutes" placeholder="10" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label>Applies to Days</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                ${['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].map(day => {
                                    const dayNames = {mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday', sat: 'Saturday', sun: 'Sunday'};
                                    return `<label style="display: flex; align-items: center;">
                                        <input type="checkbox" value="${day}" class="day-checkbox" ${['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].indexOf(day) < 5 ? 'checked' : ''} style="margin-right: 6px;">
                                        ${dayNames[day]}
                                    </label>`;
                                }).join('')}
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Create Goal</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
        }

        async function createGoal(e) {
            e.preventDefault();
            const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked')).map(cb => cb.value).join(',');
            const selectedChildren = Array.from(document.querySelectorAll('.child-checkbox:checked')).map(cb => parseInt(cb.value));
            const goalType = document.getElementById('goalType').value;
            
            if (!selectedChildren.length) {
                alert('Please select at least one child');
                return;
            }
            
            if (!selectedDays) {
                alert('Please select at least one day');
                return;
            }
            
            let rewardMinutes = 0;
            let rewardPerHour = 0;
            let bonusMinutes = 0;
            
            if (goalType === 'binary') {
                rewardMinutes = parseInt(document.getElementById('rewardMinutes').value) || 0;
                bonusMinutes = parseInt(document.getElementById('bonusMinutes').value) || 0;
                if (rewardMinutes <= 0) {
                    alert('Please enter a reward amount for this goal');
                    return;
                }
            } else {
                rewardPerHour = parseInt(document.getElementById('rewardPerHour').value) || 0;
                if (rewardPerHour <= 0) {
                    alert('Please enter a reward per hour amount for this goal');
                    return;
                }
            }
            
            const payload = {
                child_ids: selectedChildren,
                name: document.getElementById('goalName').value,
                goal_type: goalType,
                reward_minutes: rewardMinutes,
                reward_per_hour: rewardPerHour,
                bonus_minutes: bonusMinutes,
                target_minutes: 0,
                applies_to_days: selectedDays,
                is_active: true
            };

            try {
                const response = await fetch(`${API_URL}/goals/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    await loadGoals();
                    renderDashboard();
                } else {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        alert('Error creating goal: ' + JSON.stringify(errorData));
                    } else {
                        const text = await response.text();
                        console.error('Error response (text):', text);
                        alert('Error creating goal: ' + response.status + ' ' + response.statusText);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating goal: ' + error.message);
            }
        }

        function showEditGoalForm(goalId) {
            hideChildSelector();
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const daysArray = goal.applies_to_days ? goal.applies_to_days.split(',').map(d => d.trim()) : [];
            const goalChildIds = goal.children ? goal.children.map(c => c.id) : [];
            
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Edit Goal</h2>
                    <form onsubmit="updateGoal(event, ${goalId})" novalidate>
                        <div class="form-group">
                            <label>Goal Name</label>
                            <input type="text" id="goalName" placeholder="e.g., Math Practice, Read a book" value="${goal.name}">
                        </div>
                        <div class="form-group">
                            <label>Applies to Children</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                                ${children.map(child => `
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" value="${child.id}" class="child-checkbox" ${goalChildIds.includes(child.id) ? 'checked' : ''} style="margin-right: 6px;">
                                        ${child.name}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Goal Type</label>
                            <select id="goalType" onchange="toggleTargetMinutes()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="binary" ${goal.goal_type === 'binary' ? 'selected' : ''}>Binary (Earned/Not Earned)</option>
                                <option value="tracked" ${goal.goal_type === 'tracked' ? 'selected' : ''}>Tracked (Hours)</option>
                            </select>
                        </div>
                        <div class="form-group" id="rewardMinutesGroup" style="display: ${goal.goal_type === 'binary' ? 'block' : 'none'};">
                            <label>Reward Minutes</label>
                            <input type="number" id="rewardMinutes" placeholder="30" min="1" value="${goal.reward_minutes || 0}">
                        </div>
                        <div class="form-group" id="rewardPerHourGroup" style="display: ${goal.goal_type === 'tracked' ? 'block' : 'none'};">
                            <label>Reward Minutes per Hour</label>
                            <input type="number" id="rewardPerHour" placeholder="30" min="1" value="${goal.reward_per_hour || 0}">
                        </div>
                        <div class="form-group" id="bonusMinutesGroup" style="display: ${goal.goal_type === 'binary' ? 'block' : 'none'};">
                            <label>Bonus Minutes (without being asked) - Optional</label>
                            <input type="number" id="bonusMinutes" placeholder="10" min="0" value="${goal.bonus_minutes || 0}">
                        </div>
                        <div class="form-group">
                            <label>Applies to Days</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                ${['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].map(day => {
                                    const dayNames = {mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday', sat: 'Saturday', sun: 'Sunday'};
                                    return `<label style="display: flex; align-items: center;">
                                        <input type="checkbox" value="${day}" class="day-checkbox" ${daysArray.includes(day) ? 'checked' : ''} style="margin-right: 6px;">
                                        ${dayNames[day]}
                                    </label>`;
                                }).join('')}
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Update Goal</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
        }

        async function updateGoal(e, goalId) {
            e.preventDefault();
            const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked')).map(cb => cb.value).join(',');
            const selectedChildren = Array.from(document.querySelectorAll('.child-checkbox:checked')).map(cb => parseInt(cb.value));
            const goalType = document.getElementById('goalType').value;
            const goalName = document.getElementById('goalName').value;
            
            if (!goalName) {
                alert('Please enter a goal name');
                return;
            }
            
            if (!selectedChildren.length) {
                alert('Please select at least one child');
                return;
            }
            
            if (!selectedDays) {
                alert('Please select at least one day');
                return;
            }
            
            let rewardMinutes = 0;
            let rewardPerHour = 0;
            let bonusMinutes = 0;
            
            if (goalType === 'binary') {
                rewardMinutes = parseInt(document.getElementById('rewardMinutes').value) || 0;
                bonusMinutes = parseInt(document.getElementById('bonusMinutes').value) || 0;
                if (rewardMinutes <= 0) {
                    alert('Please enter a reward amount for this goal');
                    return;
                }
            } else {
                rewardPerHour = parseInt(document.getElementById('rewardPerHour').value) || 0;
                if (rewardPerHour <= 0) {
                    alert('Please enter a reward per hour amount for this goal');
                    return;
                }
            }
            
            const payload = {
                child_ids: selectedChildren,
                name: goalName,
                goal_type: goalType,
                reward_minutes: rewardMinutes,
                reward_per_hour: rewardPerHour,
                bonus_minutes: bonusMinutes,
                target_minutes: 0,
                applies_to_days: selectedDays,
                is_active: true
            };

            try {
                const response = await fetch(`${API_URL}/goals/${goalId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    await loadGoals();
                    renderDashboard();
                } else {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        alert('Error updating goal: ' + JSON.stringify(errorData));
                    } else {
                        const text = await response.text();
                        console.error('Error response (text):', text);
                        alert('Error updating goal: ' + response.status + ' ' + response.statusText);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating goal: ' + error.message);
            }
        }

        function toggleTargetMinutes() {
            const goalType = document.getElementById('goalType').value;
            const rewardMinutesGroup = document.getElementById('rewardMinutesGroup');
            const rewardPerHourGroup = document.getElementById('rewardPerHourGroup');
            const bonusMinutesGroup = document.getElementById('bonusMinutesGroup');
            
            if (goalType === 'tracked') {
                rewardMinutesGroup.style.display = 'none';
                rewardPerHourGroup.style.display = 'block';
                bonusMinutesGroup.style.display = 'none';
            } else {
                rewardMinutesGroup.style.display = 'block';
                rewardPerHourGroup.style.display = 'none';
                bonusMinutesGroup.style.display = 'block';
            }
        }

        function showAdhocRewardForm() {
            document.getElementById('childSelectorCard').style.display = 'none';
            
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Give Reward</h2>
                    <form onsubmit="createAdhocReward(event)">
                        <div class="form-group">
                            <label>Select Child</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                                ${children.map(child => `
                                    <label style="display: flex; align-items: center;">
                                        <input type="radio" name="bonusChild" value="${child.id}" class="bonus-child" ${children[0]?.id === child.id ? 'checked' : ''} style="margin-right: 6px;">
                                        ${child.name}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reward Minutes</label>
                            <input type="number" id="rewardMinutes" required placeholder="30" min="1">
                            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('rewardMinutes').value=5">5</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('rewardMinutes').value=10">10</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('rewardMinutes').value=15">15</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('rewardMinutes').value=30">30</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="rewardReason" required placeholder="e.g., Great effort on homework">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Give Reward</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
            selectedChild = children[0];
        }
        


        async function createAdhocReward(e) {
            e.preventDefault();
            
            const selectedChildId = document.querySelector('input[name="bonusChild"]:checked')?.value;
            if (!selectedChildId) {
                alert('Please select a child');
                return;
            }
            
            const payload = {
                child: parseInt(selectedChildId),
                minutes: parseInt(document.getElementById('rewardMinutes').value),
                reason: document.getElementById('rewardReason').value,
                awarded_date: formatDate(currentDate)
            };

            try {
                const response = await fetch(`${API_URL}/adhoc-rewards/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    alert('Error creating reward: ' + JSON.stringify(errorData));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating reward: ' + error.message);
            }
        }

        function showEditRewardForm(rewardId, minutes, reason) {
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Edit Reward</h2>
                    <form onsubmit="updateAdhocReward(event, ${rewardId})">
                        <div class="form-group">
                            <label>Reward Minutes</label>
                            <input type="number" id="editRewardMinutes" required value="${minutes}" min="1">
                            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editRewardMinutes').value=5">5</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editRewardMinutes').value=10">10</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editRewardMinutes').value=15">15</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editRewardMinutes').value=30">30</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editRewardMinutes').value=60">60</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="editRewardReason" required value="${reason}">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Update Reward</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
        }

        async function updateAdhocReward(e, rewardId) {
            e.preventDefault();
            const payload = {
                minutes: parseInt(document.getElementById('editRewardMinutes').value),
                reason: document.getElementById('editRewardReason').value
            };

            try {
                const response = await fetch(`${API_URL}/adhoc-rewards/${rewardId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    alert('Error updating reward');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating reward: ' + error.message);
            }
        }

        async function deleteAdhocReward(rewardId) {
            if (!confirm('Are you sure you want to delete this bonus?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/adhoc-rewards/${rewardId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    alert('Error deleting reward');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting reward: ' + error.message);
            }
        }

        function showAdhocPenaltyForm() {
            document.getElementById('childSelectorCard').style.display = 'none';
            
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Give Penalty</h2>
                    <form onsubmit="createAdhocPenalty(event)">
                        <div class="form-group">
                            <label>Select Child</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                                ${children.map(child => `
                                    <label style="display: flex; align-items: center;">
                                        <input type="radio" name="penaltyChild" value="${child.id}" class="penalty-child" ${children[0]?.id === child.id ? 'checked' : ''} style="margin-right: 6px;">
                                        ${child.name}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Penalty Minutes</label>
                            <input type="number" id="penaltyMinutes" required placeholder="15" min="1">
                            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('penaltyMinutes').value=5">5</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('penaltyMinutes').value=10">10</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('penaltyMinutes').value=15">15</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('penaltyMinutes').value=30">30</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="penaltyReason" required placeholder="e.g., Did not follow instructions">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Apply Penalty</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
            selectedChild = children[0];
        }

        async function createAdhocPenalty(e) {
            e.preventDefault();
            
            const selectedChildId = document.querySelector('input[name="penaltyChild"]:checked')?.value;
            if (!selectedChildId) {
                alert('Please select a child');
                return;
            }
            
            const payload = {
                child: parseInt(selectedChildId),
                minutes: parseInt(document.getElementById('penaltyMinutes').value),
                reason: document.getElementById('penaltyReason').value,
                applied_date: formatDate(currentDate)
            };

            try {
                const response = await fetch(`${API_URL}/adhoc-penalties/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    alert('Error creating penalty: ' + JSON.stringify(errorData));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating penalty: ' + error.message);
            }
        }

        function showEditPenaltyForm(penaltyId, minutes, reason) {
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Edit Penalty</h2>
                    <form onsubmit="updateAdhocPenalty(event, ${penaltyId})">
                        <div class="form-group">
                            <label>Penalty Minutes</label>
                            <input type="number" id="editPenaltyMinutes" required value="${minutes}" min="1">
                            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editPenaltyMinutes').value=5">5</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editPenaltyMinutes').value=10">10</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editPenaltyMinutes').value=15">15</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editPenaltyMinutes').value=30">30</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editPenaltyMinutes').value=60">60</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="editPenaltyReason" required value="${reason}">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Update Penalty</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
        }

        async function updateAdhocPenalty(e, penaltyId) {
            e.preventDefault();
            const payload = {
                minutes: parseInt(document.getElementById('editPenaltyMinutes').value),
                reason: document.getElementById('editPenaltyReason').value
            };

            try {
                const response = await fetch(`${API_URL}/adhoc-penalties/${penaltyId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    alert('Error updating penalty');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating penalty: ' + error.message);
            }
        }

        async function deleteAdhocPenalty(penaltyId) {
            if (!confirm('Are you sure you want to delete this penalty?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/adhoc-penalties/${penaltyId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    alert('Error deleting penalty');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting penalty: ' + error.message);
            }
        }

        function showEditUsageForm(usageId, minutes, notes) {
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Edit Usage</h2>
                    <form onsubmit="updateScreenTimeUsageEdit(event, ${usageId})">
                        <div class="form-group">
                            <label>Minutes Used</label>
                            <input type="number" id="editMinutesUsedInput" required value="${minutes}" min="0">
                            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editMinutesUsedInput').value=5">5</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editMinutesUsedInput').value=10">10</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editMinutesUsedInput').value=15">15</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editMinutesUsedInput').value=30">30</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('editMinutesUsedInput').value=60">60</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notes (Optional)</label>
                            <input type="text" id="editUsageNotesInput" value="${notes}">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Update Usage</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
        }

        async function updateScreenTimeUsageEdit(e, usageId) {
            e.preventDefault();
            const payload = {
                minutes_used: parseInt(document.getElementById('editMinutesUsedInput').value),
                notes: document.getElementById('editUsageNotesInput').value
            };

            try {
                const response = await fetch(`${API_URL}/screen-time-usage/${usageId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    alert('Error updating usage');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating usage: ' + error.message);
            }
        }

        async function deleteScreenTimeUsage(usageId) {
            if (!confirm('Are you sure you want to delete this usage entry?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/screen-time-usage/${usageId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    alert('Error deleting usage');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting usage: ' + error.message);
            }
        }

        async function updateScreenTimeUsage(minutesUsed) {
            const dateStr = formatDate(currentDate);
            
            try {
                // Try to find existing usage record
                const existingResponse = await fetch(`${API_URL}/screen-time-usage/?child_id=${selectedChild.id}&date=${dateStr}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const existingData = existingResponse.ok ? await existingResponse.json() : null;
                const usageId = existingData?.results?.[0]?.id;
                
                const method = usageId ? 'PATCH' : 'POST';
                const url = usageId 
                    ? `${API_URL}/screen-time-usage/${usageId}/`
                    : `${API_URL}/screen-time-usage/`;

                const payload = {
                    child: selectedChild.id,
                    date: dateStr,
                    minutes_used: minutesUsed
                };

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    alert('Error updating screen time usage');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating screen time usage: ' + error.message);
            }
        }

        function showScreenTimeUsageForm() {
            document.getElementById('childSelectorCard').style.display = 'none';
            
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Log Screen Time Usage</h2>
                    <form onsubmit="logScreenTimeUsage(event)">
                        <div class="form-group">
                            <label>Minutes Used</label>
                            <input type="number" id="minutesUsedInput" required placeholder="30" min="0" value="0">
                            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('minutesUsedInput').value=30">30</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('minutesUsedInput').value=60">60</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('minutesUsedInput').value=90">90</button>
                                <button type="button" class="btn-primary" style="padding: 12px 20px; font-size: 1.1rem;" onclick="document.getElementById('minutesUsedInput').value=120">120</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notes (Optional)</label>
                            <input type="text" id="usageNotesInput" placeholder="e.g., YouTube, Gaming">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Log Usage</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="renderDashboard()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
        }

        async function logScreenTimeUsage(e) {
            e.preventDefault();
            
            const minutesUsed = parseInt(document.getElementById('minutesUsedInput').value) || 0;
            const notes = document.getElementById('usageNotesInput').value || '';
            const dateStr = formatDate(currentDate);
            
            try {
                // Try to find existing usage record
                const existingResponse = await fetch(`${API_URL}/screen-time-usage/?child_id=${selectedChild.id}&date=${dateStr}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const existingData = existingResponse.ok ? await existingResponse.json() : null;
                const usageId = existingData?.results?.[0]?.id;
                
                const method = usageId ? 'PATCH' : 'POST';
                const url = usageId 
                    ? `${API_URL}/screen-time-usage/${usageId}/`
                    : `${API_URL}/screen-time-usage/`;

                const payload = {
                    child: selectedChild.id,
                    date: dateStr,
                    minutes_used: minutesUsed,
                    notes: notes
                };

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    renderDashboard();
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    alert('Error logging usage: ' + JSON.stringify(errorData));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error logging usage: ' + error.message);
            }
        }

        function showAddChildForm() {
            const form = `
                <div class="card">
                    <h2 style="margin-bottom: 15px;">Add New Child</h2>
                    <form onsubmit="createChild(event)">
                        <div class="form-group">
                            <label>Child's Name</label>
                            <input type="text" id="childName" required placeholder="Enter name">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Add Child</button>
                        <button type="button" class="btn-primary" style="width: 100%; background: #999; margin-top: 10px;" onclick="init()">Cancel</button>
                    </form>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = form;
        }

        async function createChild(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('childName').value
            };

            try {
                const response = await fetch(`${API_URL}/children/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    await loadChildren();
                    const newChild = await response.json();
                    selectChild(newChild.id);
                } else {
                    alert('Error creating child');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating child');
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>